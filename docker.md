Woah, a blog post? What year is it?

# Setting Up Docker

When you first install Docker, you'll have no images and no containers.

The `docker images` command comfirms this. 
```
[root@hostvm tmp]# docker images
REPOSITORY   TAG       IMAGE ID   CREATED   SIZE
```

So let's pull in an image from the internet. OWASP publishes a dockerized hackable app called WebGoat that makes a good target to play with.
```
[root@hostvm tmp]# docker pull webgoat/webgoat
Using default tag: latest
latest: Pulling from webgoat/webgoat
70cf24b16239: Already exists
084b4fa446fb: Already exists
2e6afabe6dd5: Already exists
4628a51e1d85: Already exists
72b50a542f7d: Already exists
0cb53968a62c: Already exists
4f4fb700ef54: Already exists
Digest: sha256:2775102b8186df1656f8a69cfb7a6bf6c77b43a25fa0accd6d44e6ae04c8d3b7
Status: Downloaded newer image for webgoat/webgoat:latest
docker.io/webgoat/webgoat:latest
```

Now we have a WebGoat image in our Docker registry.
```
[root@hostvm tmp]# docker images
REPOSITORY        TAG       IMAGE ID       CREATED        SIZE
webgoat/webgoat   latest    1b26d905afba   2 months ago   367MB
```

Now we can run WebGoat in a new container by issuing the `docker run` command.
```
[root@hostvm tmp]# docker run webgoat/webgoat
2023-04-20 22:50:37.618  INFO 1 --- [           main] org.owasp.webgoat.server.StartWebGoat    : Starting StartWebGoat v2023.4 using Java 17.0.6 on 8f4f8b4828f0 with PID 1 (/home/webgoat/webgoat.jar started by webgoat in /home/webgoat)
2023-04-20 22:50:37.620  INFO 1 --- [           main] org.owasp.webgoat.server.StartWebGoat    : No active profile set, falling back to 1 default profile: "default"
2023-04-20 22:50:37.774  INFO 1 --- [           main] org.owasp.webgoat.server.StartWebGoat    : Started StartWebGoat in 0.381 seconds (JVM running for 0.665)
    __          __       _        _____                   _
    \ \        / /      | |      / ____|                 | |
     \ \  /\  / /  ___  | |__   | |  __    ___     __ _  | |_
      \ \/  \/ /  / _ \ | '_ \  | | |_ |  / _ \   / _' | | __|
       \  /\  /  |  __/ | |_) | | |__| | | (_) | | (_| | | |_
        \/  \/    \___| |_.__/   \_____|  \___/   \__,_|  \__|

<--- SNIP --->
```

While the process is running, `docker ps` will show us some helpful information, like the container ID, status, and ports that are in use.

Notice that the name of this container is `amazing_goldberg`. This was randomly generated by Docker because we didn't specify one.
```
[root@hostvm tmp]# docker ps
CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS          PORTS                NAMES
dfc86e86f5dc   webgoat/webgoat   "java -Duser.home=/h…"   12 seconds ago   Up 12 seconds   8080/tcp, 9090/tcp   amazing_goldberg
```

After exiting the process, the `-a` argument must be supplied to show non-running containers.
```
[root@hostvm tmp]# docker ps -a
CONTAINER ID   IMAGE             COMMAND                  CREATED         STATUS                       PORTS     NAMES
8754b6f5189a   webgoat/webgoat   "java -Duser.home=/h…"   8 seconds ago   Exited (130) 4 seconds ago             amazing_goldberg
```

The container can be re-started by issuing the `docker start` command and the container name.
```
[root@hostvm tmp]# docker start amazing_goldberg
amazing_goldberg
```

Now we can see the process running again in `docker ps`.
```
[root@hostvm tmp]# docker ps
CONTAINER ID   IMAGE             COMMAND                  CREATED         STATUS         PORTS                NAMES
dfc86e86f5dc   webgoat/webgoat   "java -Duser.home=/h…"   7 minutes ago   Up 3 seconds   8080/tcp, 9090/tcp   amazing_goldberg
```

To make things more confusing, you can also just start a docker container directly from the internet with the `docker run` command. In this case, we've also supplied a `--name` parameter and some `-p` parameters to tell Docker how to map ports to the host.
```
docker run --name webgoat1 -it -p 127.0.0.1:8080:8080 -p 127.0.0.1:9090:9090 webgoat/webgoat
```

Why didn't I just start with that? Well, it's important to understand the differences between docker images, containers, and instances.

Now when we run `docker ps`, we see a new container running the webgoat image with the parameters we supplied. Notice how the PORTS information is represented. It is showing that the `webgoat1` container's port `8080` is now bound to port `8080` on the host's loopback interface.
```
[root@hostvm tmp]# docker ps
CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS          PORTS                                                NAMES
6ee5ecd90120   webgoat/webgoat   "java -Duser.home=/h…"   20 seconds ago   Up 19 seconds   127.0.0.1:8080->8080/tcp, 127.0.0.1:9090->9090/tcp   webgoat1
dfc86e86f5dc   webgoat/webgoat   "java -Duser.home=/h…"   20 minutes ago   Up 13 minutes   8080/tcp, 9090/tcp                                   amazing_goldberg
```

We can also create a container without starting it by issuing the `docker create` command.
```
[root@hostvm tmp]# docker create --name webgoat2 -p 127.0.0.1:8081:8080 -p 127.0.0.1:9091:9090 webgoat/webgoat
74113b5ff13a75498c9d03c8dbfa9a11ac6c4a18176f8dcba1441a2fcf68f9fb
```

Now we can see the new container with `docker ps -a`. Notice that it doesn't show any ports in use when the container isn't running.
```
[root@hostvm tmp]# docker ps -a
CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS          PORTS                                                NAMES
74113b5ff13a   webgoat/webgoat   "java -Duser.home=/h…"   13 seconds ago   Created                                                              webgoat2
6ee5ecd90120   webgoat/webgoat   "java -Duser.home=/h…"   5 minutes ago    Up 5 minutes    127.0.0.1:8080->8080/tcp, 127.0.0.1:9090->9090/tcp   webgoat1
dfc86e86f5dc   webgoat/webgoat   "java -Duser.home=/h…"   25 minutes ago   Up 19 minutes   8080/tcp, 9090/tcp                                   amazing_goldberg
```

If we start the container, we see the port bindings.

```
[root@hostvm tmp]# $ docker start webgoat2
webgoat2

[root@hostvm tmp]# docker ps -a
CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS         PORTS                                                NAMES
74113b5ff13a   webgoat/webgoat   "java -Duser.home=/h…"   18 hours ago   Up 4 seconds   127.0.0.1:8081->8080/tcp, 127.0.0.1:9091->9090/tcp   webgoat2
6ee5ecd90120   webgoat/webgoat   "java -Duser.home=/h…"   18 hours ago   Up 18 hours    127.0.0.1:8080->8080/tcp, 127.0.0.1:9090->9090/tcp   webgoat1
dfc86e86f5dc   webgoat/webgoat   "java -Duser.home=/h…"   18 hours ago   Up 18 hours    8080/tcp, 9090/tcp                                   amazing_goldberg
```

# Dockerfile
```
FROM webgoat/webgoat 
EXPOSE 8082
EXPOSE 9092
```

```
[root@hostvm tmp]# docker build .
[+] Building 0.1s (5/5) FINISHED
 => [internal] load build definition from Dockerfile                                                                                                                         0.0s
 => => transferring dockerfile: 99B                                                                                                                                          0.0s
 => [internal] load .dockerignore                                                                                                                                            0.0s
 => => transferring context: 2B                                                                                                                                              0.0s
 => [internal] load metadata for docker.io/webgoat/webgoat:latest                                                                                                            0.0s
 => CACHED [1/1] FROM docker.io/webgoat/webgoat                                                                                                                              0.0s
 => exporting to image                                                                                                                                                       0.0s
 => => exporting layers                                                                                                                                                      0.0s
 => => writing image sha256:8fe5aea7819254b6fd465a512cb2d92fe41c629cf5e296010582542573fb808b
```

```
[root@hostvm tmp]# docker images
REPOSITORY        TAG       IMAGE ID       CREATED        SIZE
webgoat/webgoat   latest    1b26d905afba   2 months ago   367MB
<none>            <none>    8fe5aea78192   2 months ago   367MB
```

```
[root@hostvm tmp]# docker create --name webgoat3 8fe5aea78192
88dcf0c130a5cd602cb3bfbf314dcb868c20dfea0ebf718459ab9b333e195a2c

[root@hostvm tmp]# docker start 88dcf0c130a5cd60
```

# Run an interactive shell in a docker container
```
[root@hostvm tmp]# docker exec -t -i dfc86e86f5dc /bin/bash
webgoat@dfc86e86f5dc:~$ id
uid=1000(webgoat) gid=1000(webgoat) groups=1000(webgoat)
```



# Docker Logs

```
[root@hostvm]# docker logs dfc86e86f5dc | head
2023-04-28 18:00:11.191  INFO 1 --- [           main] org.owasp.webgoat.server.StartWebGoat    : Starting StartWebGoat v2023.4 using Java 17.0.6 on ca008762e976 with PID 1 (/home/webgoat/webgoat.jar started by webgoat in /home/webgoat)
2023-04-28 18:00:11.209  INFO 1 --- [           main] org.owasp.webgoat.server.StartWebGoat    : No active profile set, falling back to 1 default profile: "default"
2023-04-28 18:00:12.662  INFO 1 --- [           main] org.owasp.webgoat.server.StartWebGoat    : Started StartWebGoat in 3.78 seconds (JVM running for 6.639)
    __          __       _        _____                   _
    \ \        / /      | |      / ____|                 | |
     \ \  /\  / /  ___  | |__   | |  __    ___     __ _  | |_
      \ \/  \/ /  / _ \ | '_ \  | | |_ |  / _ \   / _' | | __|
       \  /\  /  |  __/ | |_) | | |__| | | (_) | | (_| | | |_
        \/  \/    \___| |_.__/   \_____|  \___/   \__,_|  \__|

```



# Docker inspect

```
docker inspect $(docker ps -aq) | jq '.[] | { Name, Id, Overlay: .GraphDriver.Data.MergedDir, Labels: .Config.Labels, Binds: .HostConfig.Binds, Networks: .NetworkSettings.Networks, ExposedPorts: .Config.ExposedPorts, PortBindings: .HostConfig.PortBindings }'
```




```json
{
  "Name": "/webgoat3",
  "Id": "88dcf0c130a5cd602cb3bfbf314dcb868c20dfea0ebf718459ab9b333e195a2c",
  "Overlay": "/var/lib/docker/overlay2/ca2a3443515fa64786cb538a9d272cdff896dc1772221041c92aea9fc02a4ed5/merged",
  "Labels": {
    "NAME": "= WebGoat: A deliberately insecure Web Application",
    "org.opencontainers.image.ref.name": "ubuntu",
    "org.opencontainers.image.version": "20.04"
  },
  "Binds": null,
  "Networks": {
    "bridge": {
      "IPAMConfig": null,
      "Links": null,
      "Aliases": null,
      "NetworkID": "23bcb7cf55c880ccfb58f0e47ebc6d4b2195c3c12cf29d4be80e395928d2987d",
      "EndpointID": "",
      "Gateway": "",
      "IPAddress": "",
      "IPPrefixLen": 0,
      "IPv6Gateway": "",
      "GlobalIPv6Address": "",
      "GlobalIPv6PrefixLen": 0,
      "MacAddress": "",
      "DriverOpts": null
    }
  },
  "ExposedPorts": {
    "8080/tcp": {},
    "8082/tcp": {},
    "9090/tcp": {},
    "9092/tcp": {}
  },
  "PortBindings": {}
}
{
  "Name": "/webgoat2",
  "Id": "74113b5ff13a75498c9d03c8dbfa9a11ac6c4a18176f8dcba1441a2fcf68f9fb",
  "Overlay": "/var/lib/docker/overlay2/62508584def8e543e23f2f7d3e97a06a2243945b62b440fada357f5a77aa062e/merged",
  "Labels": {
    "NAME": "= WebGoat: A deliberately insecure Web Application",
    "org.opencontainers.image.ref.name": "ubuntu",
    "org.opencontainers.image.version": "20.04"
  },
  "Binds": null,
  "Networks": {
    "bridge": {
      "IPAMConfig": null,
      "Links": null,
      "Aliases": null,
      "NetworkID": "23bcb7cf55c880ccfb58f0e47ebc6d4b2195c3c12cf29d4be80e395928d2987d",
      "EndpointID": "",
      "Gateway": "",
      "IPAddress": "",
      "IPPrefixLen": 0,
      "IPv6Gateway": "",
      "GlobalIPv6Address": "",
      "GlobalIPv6PrefixLen": 0,
      "MacAddress": "",
      "DriverOpts": null
    }
  },
  "ExposedPorts": {
    "8080/tcp": {},
    "9090/tcp": {}
  },
  "PortBindings": {
    "8080/tcp": [
      {
        "HostIp": "127.0.0.1",
        "HostPort": "8081"
      }
    ],
    "9090/tcp": [
      {
        "HostIp": "127.0.0.1",
        "HostPort": "9091"
      }
    ]
  }
}
{
  "Name": "/webgoat1",
  "Id": "6ee5ecd90120daf14729d966f23587f4e9565e81ee3ce6bb6794548ff5b71089",
  "Overlay": "/var/lib/docker/overlay2/6b37e86a56a75c1d3bbc30d3bbb8996867c867b1abbf4cfb31ffbddac0ceeb68/merged",
  "Labels": {
    "NAME": "= WebGoat: A deliberately insecure Web Application",
    "org.opencontainers.image.ref.name": "ubuntu",
    "org.opencontainers.image.version": "20.04"
  },
  "Binds": null,
  "Networks": {
    "bridge": {
      "IPAMConfig": null,
      "Links": null,
      "Aliases": null,
      "NetworkID": "23bcb7cf55c880ccfb58f0e47ebc6d4b2195c3c12cf29d4be80e395928d2987d",
      "EndpointID": "",
      "Gateway": "",
      "IPAddress": "",
      "IPPrefixLen": 0,
      "IPv6Gateway": "",
      "GlobalIPv6Address": "",
      "GlobalIPv6PrefixLen": 0,
      "MacAddress": "",
      "DriverOpts": null
    }
  },
  "ExposedPorts": {
    "8080/tcp": {},
    "9090/tcp": {}
  },
  "PortBindings": {
    "8080/tcp": [
      {
        "HostIp": "127.0.0.1",
        "HostPort": "8080"
      }
    ],
    "9090/tcp": [
      {
        "HostIp": "127.0.0.1",
        "HostPort": "9090"
      }
    ]
  }
}
{
  "Name": "/amazing_goldberg",
  "Id": "dfc86e86f5dc2756422e6c1ddb545948eda06271dd1021f6541763e6715837fc",
  "Overlay": "/var/lib/docker/overlay2/41e000b50fde663b3fae2bfc170ca3941e86a22f4694ed7e0308f087df6894f4/merged",
  "Labels": {
    "NAME": "= WebGoat: A deliberately insecure Web Application",
    "org.opencontainers.image.ref.name": "ubuntu",
    "org.opencontainers.image.version": "20.04"
  },
  "Binds": null,
  "Networks": {
    "bridge": {
      "IPAMConfig": null,
      "Links": null,
      "Aliases": null,
      "NetworkID": "23bcb7cf55c880ccfb58f0e47ebc6d4b2195c3c12cf29d4be80e395928d2987d",
      "EndpointID": "6aa7109697884a8cf2f1e62de759979494b7ca82286c8b5cebc9c09c38049d14",
      "Gateway": "172.17.0.1",
      "IPAddress": "172.17.0.2",
      "IPPrefixLen": 16,
      "IPv6Gateway": "",
      "GlobalIPv6Address": "",
      "GlobalIPv6PrefixLen": 0,
      "MacAddress": "02:42:ac:11:00:02",
      "DriverOpts": null
    }
  },
  "ExposedPorts": {
    "8080/tcp": {},
    "9090/tcp": {}
  },
  "PortBindings": {}
}
